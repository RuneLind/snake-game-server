<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Snake AI Arena</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0a0a;
    color: #eee;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    overflow: hidden;
    height: 100vh;
  }
  #container {
    display: flex;
    height: 100vh;
  }
  #game-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }
  #canvas {
    background: #111;
    border: 2px solid #333;
  }
  #sidebar {
    width: 320px;
    background: #141414;
    border-left: 2px solid #333;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  #sidebar-header {
    padding: 16px;
    border-bottom: 1px solid #333;
    text-align: center;
  }
  #sidebar-header h1 {
    font-size: 20px;
    font-weight: 700;
    letter-spacing: 2px;
    color: #fff;
  }
  #game-info {
    padding: 8px 16px;
    font-size: 12px;
    color: #666;
    border-bottom: 1px solid #222;
    display: flex;
    justify-content: space-between;
  }
  #leaderboard {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
  }
  .snake-row {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    margin-bottom: 4px;
    border-radius: 8px;
    background: #1a1a1a;
    transition: all 0.3s ease;
  }
  .snake-row.dead {
    opacity: 0.4;
  }
  .snake-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    margin-right: 10px;
    flex-shrink: 0;
  }
  .snake-info {
    flex: 1;
    min-width: 0;
  }
  .snake-name {
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .snake-stats {
    font-size: 11px;
    color: #888;
    margin-top: 2px;
  }
  .snake-score {
    font-size: 18px;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    margin-left: 8px;
  }
  .snake-status {
    margin-left: 8px;
    font-size: 14px;
  }
  #overlay {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    z-index: 10;
  }
  #overlay-text {
    font-size: 64px;
    font-weight: 900;
    color: #fff;
    text-shadow: 0 0 40px rgba(255,255,255,0.3);
    opacity: 0;
    transition: opacity 0.5s ease;
  }
  #overlay-text.visible {
    opacity: 1;
  }
  #notifications {
    position: absolute;
    top: 16px;
    left: 16px;
    z-index: 20;
  }
  .notification {
    background: rgba(0,0,0,0.8);
    border: 1px solid #444;
    border-radius: 8px;
    padding: 8px 16px;
    margin-bottom: 8px;
    font-size: 14px;
    animation: fadeInOut 3s ease forwards;
  }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-20px); }
    10% { opacity: 1; transform: translateX(0); }
    80% { opacity: 1; }
    100% { opacity: 0; }
  }
</style>
</head>
<body>
<div id="container">
  <div id="game-area">
    <canvas id="canvas"></canvas>
    <div id="overlay">
      <div id="overlay-text"></div>
    </div>
    <div id="notifications"></div>
  </div>
  <div id="sidebar">
    <div id="sidebar-header">
      <h1>SNAKE AI ARENA</h1>
    </div>
    <div id="game-info">
      <span id="tick-info">Tick: 0</span>
      <span id="status-info">Waiting</span>
      <span id="spectator-info">0 watching</span>
    </div>
    <div id="leaderboard"></div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const leaderboard = document.getElementById('leaderboard');
const tickInfo = document.getElementById('tick-info');
const statusInfo = document.getElementById('status-info');
const spectatorInfo = document.getElementById('spectator-info');
const overlayText = document.getElementById('overlay-text');
const notifications = document.getElementById('notifications');

let currentState = null;
let cellSize = 16;

function resizeCanvas() {
  if (!currentState) return;
  const area = document.getElementById('game-area');
  const maxW = area.clientWidth - 32;
  const maxH = area.clientHeight - 32;
  cellSize = Math.floor(Math.min(maxW / currentState.boardWidth, maxH / currentState.boardHeight));
  canvas.width = currentState.boardWidth * cellSize;
  canvas.height = currentState.boardHeight * cellSize;
  render();
}

window.addEventListener('resize', resizeCanvas);

function render() {
  if (!currentState) return;
  const { boardWidth, boardHeight, snakes, food } = currentState;
  const w = boardWidth * cellSize;
  const h = boardHeight * cellSize;

  // Background
  ctx.fillStyle = '#111';
  ctx.fillRect(0, 0, w, h);

  // Grid lines
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 1;
  for (let x = 0; x <= boardWidth; x++) {
    ctx.beginPath();
    ctx.moveTo(x * cellSize, 0);
    ctx.lineTo(x * cellSize, h);
    ctx.stroke();
  }
  for (let y = 0; y <= boardHeight; y++) {
    ctx.beginPath();
    ctx.moveTo(0, y * cellSize);
    ctx.lineTo(w, y * cellSize);
    ctx.stroke();
  }

  // Food
  for (const f of food) {
    const fx = f.position.x * cellSize;
    const fy = f.position.y * cellSize;
    const pad = Math.floor(cellSize * 0.2);
    ctx.fillStyle = f.value > 1 ? '#ff6b6b' : '#ffd43b';
    ctx.beginPath();
    ctx.arc(fx + cellSize/2, fy + cellSize/2, (cellSize - pad*2)/2, 0, Math.PI * 2);
    ctx.fill();
  }

  // Snakes
  for (const snake of snakes) {
    if (!snake.alive || snake.segments.length === 0) continue;

    // Body segments
    for (let i = 1; i < snake.segments.length; i++) {
      const seg = snake.segments[i];
      const pad = 1;
      ctx.fillStyle = snake.color;
      ctx.fillRect(seg.x * cellSize + pad, seg.y * cellSize + pad, cellSize - pad*2, cellSize - pad*2);
    }

    // Head (brighter)
    const head = snake.segments[0];
    ctx.fillStyle = lightenColor(snake.color, 40);
    const pad = 1;
    ctx.fillRect(head.x * cellSize + pad, head.y * cellSize + pad, cellSize - pad*2, cellSize - pad*2);

    // Eyes
    drawEyes(head, snake.direction, snake.color);

    // Name label
    ctx.font = `bold ${Math.max(10, cellSize * 0.7)}px sans-serif`;
    ctx.fillStyle = '#fff';
    ctx.textAlign = 'center';
    ctx.shadowColor = 'rgba(0,0,0,0.8)';
    ctx.shadowBlur = 4;
    ctx.fillText(snake.participantName, head.x * cellSize + cellSize/2, head.y * cellSize - 4);
    ctx.shadowBlur = 0;
  }
}

function drawEyes(head, direction, color) {
  const cx = head.x * cellSize + cellSize / 2;
  const cy = head.y * cellSize + cellSize / 2;
  const eyeSize = Math.max(2, cellSize * 0.15);
  const offset = cellSize * 0.2;

  let e1, e2;
  switch (direction) {
    case 'UP':    e1 = { x: cx - offset, y: cy - offset }; e2 = { x: cx + offset, y: cy - offset }; break;
    case 'DOWN':  e1 = { x: cx - offset, y: cy + offset }; e2 = { x: cx + offset, y: cy + offset }; break;
    case 'LEFT':  e1 = { x: cx - offset, y: cy - offset }; e2 = { x: cx - offset, y: cy + offset }; break;
    case 'RIGHT': e1 = { x: cx + offset, y: cy - offset }; e2 = { x: cx + offset, y: cy + offset }; break;
    default: return;
  }

  ctx.fillStyle = '#fff';
  ctx.beginPath(); ctx.arc(e1.x, e1.y, eyeSize, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(e2.x, e2.y, eyeSize, 0, Math.PI * 2); ctx.fill();
  ctx.fillStyle = '#000';
  ctx.beginPath(); ctx.arc(e1.x, e1.y, eyeSize * 0.5, 0, Math.PI * 2); ctx.fill();
  ctx.beginPath(); ctx.arc(e2.x, e2.y, eyeSize * 0.5, 0, Math.PI * 2); ctx.fill();
}

function lightenColor(hex, amount) {
  const num = parseInt(hex.replace('#', ''), 16);
  const r = Math.min(255, (num >> 16) + amount);
  const g = Math.min(255, ((num >> 8) & 0xff) + amount);
  const b = Math.min(255, (num & 0xff) + amount);
  return `rgb(${r},${g},${b})`;
}

function updateLeaderboard() {
  if (!currentState) return;

  const sorted = [...currentState.snakes].sort((a, b) => b.totalScore - a.totalScore);

  leaderboard.innerHTML = sorted.map((s, i) => `
    <div class="snake-row ${s.alive ? '' : 'dead'}">
      <div class="snake-color" style="background: ${s.color}"></div>
      <div class="snake-info">
        <div class="snake-name">${escapeHtml(s.participantName)}</div>
        <div class="snake-stats">
          L:${s.length} K:${s.totalKills}
          ${!s.alive && s.deathReason ? ' \u2620 ' + formatDeathReason(s.deathReason) : ''}
        </div>
      </div>
      <div class="snake-score" style="color: ${s.color}">${s.totalScore}</div>
      <div class="snake-status">${s.alive ? '\u{1F7E2}' : '\u{1F480}'}</div>
    </div>
  `).join('');
}

function formatDeathReason(reason) {
  if (!reason) return '';
  if (reason === 'wall') return 'hit wall';
  if (reason === 'self') return 'hit self';
  if (reason.startsWith('snake:')) return 'killed by ' + reason.slice(6);
  if (reason.startsWith('headon:')) return 'head-on with ' + reason.slice(7);
  return reason;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function showOverlay(text, durationMs = 2000) {
  overlayText.textContent = text;
  overlayText.classList.add('visible');
  setTimeout(() => overlayText.classList.remove('visible'), durationMs);
}

function addNotification(text, color = '#fff') {
  const el = document.createElement('div');
  el.className = 'notification';
  el.style.borderLeftColor = color;
  el.style.borderLeftWidth = '3px';
  el.textContent = text;
  notifications.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

// Socket.io connection
const socket = io();

socket.on('game:tick', (state) => {
  const firstUpdate = !currentState;
  currentState = state;
  if (firstUpdate) resizeCanvas();
  tickInfo.textContent = `Tick: ${state.tick}`;
  statusInfo.textContent = state.status.charAt(0).toUpperCase() + state.status.slice(1);
  spectatorInfo.textContent = `${state.spectatorCount} watching`;
  render();
  updateLeaderboard();
});

socket.on('game:started', () => {
  showOverlay('GO!', 1500);
});

socket.on('game:paused', () => {
  showOverlay('PAUSED');
});

socket.on('game:finished', (data) => {
  showOverlay(`${data.winnerName || 'Nobody'} WINS!`, 5000);
});

socket.on('snake:registered', (data) => {
  addNotification(`${data.name} joined!`, data.color);
});

socket.on('snake:died', (data) => {
  addNotification(`${data.name} died: ${formatDeathReason(data.reason)}`, '#ff4444');
});

socket.on('snake:respawned', (data) => {
  addNotification(`${data.name} respawned`, '#44ff44');
});

socket.on('connect', () => {
  console.log('Connected to game server');
});

socket.on('disconnect', () => {
  showOverlay('DISCONNECTED', 10000);
});
</script>
</body>
</html>
